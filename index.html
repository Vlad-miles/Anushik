<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤–æ–≥–æ–¥–Ω—è—è –ì–æ–Ω–∫–∞ –≠–ª—å—Ñ–æ–≤! üèÅüéÑ</title>
    <style>
        body {
            background: linear-gradient(to bottom, #001133, #003366);
            color: #fff;
            font-family: 'Arial Black', Arial, sans-serif;
            text-align: center;
            padding: 10px;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        #snow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .snowflake {
            position: absolute;
            color: #fff;
            font-size: 1.5em;
            animation: fall linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
        }
        h1 {
            font-size: 2em;
            color: #ffcc00;
            text-shadow: 0 0 20px #ff0000;
            margin: 10px 0;
            z-index: 10;
            position: relative;
        }
        #host-screen, #team-screen {
            display: none;
            max-width: 1000px;
            margin: 0 auto;
            z-index: 10;
            position: relative;
        }
        #lobby {
            display: block;
        }
        button {
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff0000, #cc0000);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(255,0,0,0.5);
        }
        button:hover, button.active {
            background: linear-gradient(45deg, #ff6600, #ff0000);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255,0,0,0.7);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        input, select {
            padding: 15px;
            font-size: 1.1em;
            border-radius: 10px;
            border: 2px solid #ffcc00;
            background: rgba(255,255,255,0.9);
            margin: 10px;
            width: 200px;
        }
        .leaderboard {
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .team {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            font-size: 1.2em;
        }
        .team-name { color: #ffcc00; }
        .team-score { color: #00ff00; font-weight: bold; }
        #map {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .location {
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.3);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 10px;
            position: relative;
            transition: all 0.5s;
        }
        .location.current { background: #ffcc00; box-shadow: 0 0 30px #ffcc00; }
        .location.leader { background: linear-gradient(45deg, #00ff00, #00cc00); box-shadow: 0 0 30px #00ff00; }
        #challenge {
            font-size: 1.5em;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .answers {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
            margin: 20px auto;
        }
        #timer {
            font-size: 3em;
            color: #ff0000;
            text-shadow: 0 0 20px #ff0000;
        }
        #clicker {
            font-size: 4em;
            height: 200px;
            width: 200px;
            border-radius: 50%;
            background: radial-gradient(#ffcc00, #ff6600);
            border: none;
            margin: 20px auto;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 10px 30px rgba(255,204,0,0.5);
        }
        #clicker:active {
            transform: scale(0.95);
        }
        .progress {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffcc00);
            width: 0%;
            transition: width 0.3s;
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.5em; }
            button { padding: 12px 20px; font-size: 1em; }
            .location { width: 120px; height: 120px; font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div id="snow"></div>
    <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –ì–æ–Ω–∫–∞ –≠–ª—å—Ñ–æ–≤! üèÅüéÖ</h1>

    <!-- –õ–æ–±–±–∏: —Å–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ -->
    <div id="lobby">
        <div style="background: rgba(0,0,0,0.5); padding: 40px; border-radius: 25px; max-width: 500px; margin: 0 auto;">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–µ–º–µ–π–Ω—É—é –≥–æ–Ω–∫—É!</h2>
            <p>–†–∞–∑–¥–µ–ª–∏—Ç–µ—Å—å –ø–æ –ø–∞—Ä–∞–º (–¥–æ 4 –∫–æ–º–∞–Ω–¥). –ò–≥—Ä–∞–π—Ç–µ –Ω–∞ –±–æ–ª—å—à–æ–º —ç–∫—Ä–∞–Ω–µ + —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö.</p>
            <br>
            <button onclick="createRoom()">üì∫ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É (–≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω)</button>
            <br><br>
            <input id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (4 –±—É–∫–≤—ã)" maxlength="4" style="text-transform: uppercase;">
            <button onclick="joinRoom()">üì± –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –∫–æ–º–∞–Ω–¥–∞</button>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (—Ö–æ—Å—Ç) -->
    <div id="host-screen">
        <div class="leaderboard">
            <h2>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</h2>
            <div id="teams-list"></div>
        </div>
        <div id="map">
            <div class="location" id="loc1">üè†<br>–°—Ç–∞—Ä—Ç</div>
            <div class="location" id="loc2">üõ†Ô∏è<br>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</div>
            <div class="location" id="loc3">üå≤<br>–Å–ª–æ—á–Ω—ã–π –ª–µ—Å</div>
            <div class="location" id="loc4">‚õÑ<br>–°–Ω–µ–∂–Ω–∞—è –ø–æ–ª—è–Ω–∞</div>
            <div class="location" id="loc5">üéÅ<br>–§–∏–Ω–∏—à!</div>
        </div>
        <div id="challenge"></div>
        <button id="next-round" onclick="nextRound()" style="display:none; font-size:1.3em;">üöÄ –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥!</button>
        <button onclick="resetGame()" style="background:#00aa00;">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∫–æ–º–∞–Ω–¥—ã -->
    <div id="team-screen">
        <h2 id="team-name">–ö–æ–º–∞–Ω–¥–∞</h2>
        <div id="team-progress"></div>
        <div id="team-challenge"></div>
        <div id="results"></div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, push, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA_yq2pxU6qX1rYkegVbo0Q_7oHdwS-krs",
            authDomain: "fir-browser-example.firebaseapp.com",
            databaseURL: "https://fir-browser-example-default-rtdb.firebaseio.com",
            projectId: "fir-browser-example",
            storageBucket: "fir-browser-example.appspot.com",
            messagingSenderId: "930799896995",
            appId: "1:930799896995:web:9da1362e937846d52b95e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let roomCode = '';
        let isHost = false;
        let myTeam = null;
        let teams = {};
        let currentRound = 0;
        let challengeTimer = null;
        let roundData = null;

        // –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –≤—ã–∑–æ–≤—ã (7 —Ä–∞—É–Ω–¥–æ–≤)
        const challenges = [
            { type: 'quiz', question: '–ö—Ç–æ –ø—Ä–∏–≤–æ–∑–∏—Ç –ø–æ–¥–∞—Ä–∫–∏ –≤ –ù–æ–≤—ã–π –≥–æ–¥?', answers: ['–î–µ–¥ –ú–æ—Ä–æ–∑', '–°–∞–Ω—Ç–∞', '–ó–º–µ–π –ì–æ—Ä—ã–Ω—ã—á', '–ë–∞–±–∞ –Ø–≥–∞'], correct: 0, points: 10 },
            { type: 'riddle', question: '–ß—Ç–æ –≤–∏—Å–∏—Ç –Ω–∞ —ë–ª–∫–µ –∏ —Å–≤–µ—Ç–∏—Ç? (–í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∏–∂–µ)', answers: ['–®–∞—Ä–∏–∫', '–ì–∏—Ä–ª—è–Ω–¥–∞', '–°–Ω–µ–∂–∏–Ω–∫–∞', '–ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫'], correct: 1, points: 15 },
            { type: 'quiz', question: '–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–ª–∏—Ç—Å—è –ù–æ–≤—ã–π –≥–æ–¥?', answers: ['1', '7', '12', '365'], correct: 0, points: 10 },
            { type: 'speed', question: '–ö–õ–ò–ö–ê–ô–¢–ï –ë–´–°–¢–†–û! 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å–±–æ—Ä —Å–Ω–µ–∂–∏–Ω–æ–∫! ‚ùÑ‚ùÑ‚ùÑ', duration: 10, pointsPerClick: 1 },
            { type: 'quiz', question: '–ö–∞–∫ –∑–æ–≤—É—Ç –≤–Ω—É—á–∫—É –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞?', answers: ['–°–Ω–µ–≥—É—Ä–æ—á–∫–∞', '–°–Ω–µ–∂–∞–Ω–Ω–∞', '–ú–æ—Ä–æ–∑–∫–æ', '–Å–ª–∫–∞'], correct: 0, points: 20 },
            { type: 'riddle', question: '–Ø –∑–µ–ª—ë–Ω–∞—è, –∫–æ–ª—é—á–∞—è, –≤ –ù–æ–≤—ã–π –≥–æ–¥ –≤ –¥–æ–º–µ —Å—Ç–æ—é. –ß—Ç–æ —è?', answers: ['–°–æ—Å–Ω–∞', '–Å–ª–∫–∞', '–ö–æ–ª—é—á–∫–∞', '–û–≥—É—Ä–µ—Ü'], correct: 1, points: 15 },
            { type: 'speed', question: '–§–ò–ù–ê–õ–¨–ù–´–ô –°–ü–†–ò–ù–¢! –ö–õ–ò–ö–ê–ô–¢–ï 15 —Å–µ–∫! üèÉ‚Äç‚ôÇÔ∏èüí®', duration: 15, pointsPerClick: 2 }
        ];

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        function generateCode() {
            return Math.random().toString(36).substring(2,6).toUpperCase();
        }

        // –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        window.createRoom = function() {
            roomCode = generateCode();
            document.getElementById('roomCode').value = roomCode;
            isHost = true;
            set(ref(db, `rooms/${roomCode}`), {
                host: true,
                round: 0,
                started: false,
                teams: {}
            }).then(() => {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('host-screen').style.display = 'block';
                listenToRoom();
                startSnow();
            });
        };

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
        window.joinRoom = function() {
            roomCode = document.getElementById('roomCode').value.toUpperCase();
            if (roomCode.length !== 4) return alert('–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 –±—É–∫–≤—ã!');
            myTeam = prompt('–ò–º—è –≤–∞—à–µ–π –ø–∞—Ä—ã/–∫–æ–º–∞–Ω–¥—ã:');
            if (!myTeam) return;
            const teamRef = ref(db, `rooms/${roomCode}/teams/${myTeam}`);
            set(teamRef, { score: 0, progress: 0, ready: false, answer: null, clicks: 0 });
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('team-screen').style.display = 'block';
            document.getElementById('team-name').textContent = `üéÆ ${myTeam}`;
            listenToRoom();
            startSnow();
        };

        // –°–ª—É—à–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        function listenToRoom() {
            const roomRef = ref(db, `rooms/${roomCode}`);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                teams = data.teams || {};
                currentRound = data.round || 0;
                if (isHost) {
                    updateHostScreen();
                    if (data.started && currentRound < challenges.length) {
                        startChallenge();
                    }
                } else {
                    updateTeamScreen();
                }
            });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Ö–æ—Å—Ç —ç–∫—Ä–∞–Ω
        function updateHostScreen() {
            const list = document.getElementById('teams-list');
            list.innerHTML = '';
            let totalTeams = 0;
            Object.keys(teams).forEach(name => {
                totalTeams++;
                const div = document.createElement('div');
                div.className = 'team';
                div.innerHTML = `<span class="team-name">${name}</span><span class="team-score">${teams[name].score || 0} ‚≠ê</span>`;
                list.appendChild(div);
            });
            if (totalTeams < 2) {
                document.getElementById('next-round').style.display = 'none';
                return;
            }
            // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –ª–æ–∫–∞—Ü–∏–∏
            document.querySelectorAll('.location').forEach((loc, i) => {
                loc.classList.remove('current', 'leader');
                const maxProgress = Math.max(...Object.values(teams).map(t => t.progress || 0));
                if (i === (currentRound || 0)) loc.classList.add('current');
                if (maxProgress >= i+1) loc.classList.add('leader');
            });
            document.getElementById('next-round').style.display = currentRound < challenges.length ? 'inline-block' : 'none';
        }

        // –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
        window.nextRound = function() {
            const newRound = currentRound + 1;
            set(ref(db, `rooms/${roomCode}`), { round: newRound, started: true });
            // –°–±—Ä–æ—Å–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –∫–æ–º–∞–Ω–¥
            Object.keys(teams).forEach(name => {
                set(ref(db, `rooms/${roomCode}/teams/${name}`), { ...teams[name], ready: false, answer: null, clicks: 0 });
            });
        };

        // –°—Ç–∞—Ä—Ç —á–µ–ª–ª–µ–Ω–¥–∂–∞
        function startChallenge() {
            roundData = challenges[currentRound];
            const challengeEl = document.getElementById('challenge');
            challengeEl.innerHTML = `
                <h2>–†–∞—É–Ω–¥ ${currentRound + 1}: ${roundData.question}</h2>
                <div id="timer"></div>
                <div class="progress"><div class="progress-bar" id="prog-bar"></div></div>
            `;
            if (roundData.type === 'speed') {
                challengeEl.innerHTML += '<button id="clicker" onclick="teamClick()">‚ùÑ –ö–õ–ò–ö!</button>';
            }
            startTimer(roundData.duration || 20);
        }

        // –¢–∞–π–º–µ—Ä
        function startTimer(duration) {
            let time = duration;
            const timerEl = document.getElementById('timer');
            const progEl = document.getElementById('prog-bar');
            challengeTimer = setInterval(() => {
                time--;
                timerEl.textContent = time;
                progEl.style.width = ((duration - time) / duration * 100) + '%';
                if (time <= 0) {
                    clearInterval(challengeTimer);
                    endRound();
                }
            }, 1000);
        }

        // –ö–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞
        function endRound() {
            // –ü–æ–¥—Å—á—ë—Ç –æ—á–∫–æ–≤
            Object.keys(teams).forEach(name => {
                const team = teams[name];
                let points = 0;
                if (roundData.type === 'quiz' || roundData.type === 'riddle') {
                    if (team.answer === roundData.correct) points = roundData.points;
                } else if (roundData.type === 'speed') {
                    points = team.clicks * roundData.pointsPerClick;
                }
                const newScore = (team.score || 0) + points;
                const newProgress = Math.min(5, (team.progress || 0) + 1);
                set(ref(db, `rooms/${roomCode}/teams/${name}`), {
                    ...team,
                    score: newScore,
                    progress: newProgress
                });
            });
            setTimeout(() => {
                alert(`–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω! –û–±–Ω–æ–≤–∏—Ç–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞ –ø–æ–ª—É—á–∏—Ç –±–æ–Ω—É—Å –≤ –æ—á–∫–∞—Ö!`);
            }, 2000);
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —ç–∫—Ä–∞–Ω –∫–æ–º–∞–Ω–¥—ã
        function updateTeamScreen() {
            const progressEl = document.getElementById('team-progress');
            progressEl.innerHTML = `
                <h3>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å: ${teams[myTeam]?.progress || 0}/5</h3>
                <div class="progress"><div class="progress-bar" style="width: ${(teams[myTeam]?.progress || 0)/5 * 100}%"></div></div>
            `;
            const challengeEl = document.getElementById('team-challenge');
            if (currentRound < challenges.length && roundData) {
                if (roundData.type === 'quiz' || roundData.type === 'riddle') {
                    challengeEl.innerHTML = `
                        <h3>${roundData.question}</h3>
                        <div class="answers">
                            ${roundData.answers.map((ans, i) => `<button onclick="submitAnswer(${i})">${ans}</button>`).join('')}
                        </div>
                    `;
                } else {
                    challengeEl.innerHTML = `
                        <h3>${roundData.question}</h3>
                        <button id="team-clicker" onclick="teamClick()">‚ùÑ –ö–õ–ò–ö!</button>
                        <p>–ö–ª–∏–∫–æ–≤: <span id="click-count">0</span></p>
                    `;
                }
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∫–æ–º–∞–Ω–¥—ã
        window.submitAnswer = function(answer) {
            set(ref(db, `rooms/${roomCode}/teams/${myTeam}`), { ...teams[myTeam], ready: true, answer });
            document.querySelectorAll('#team-challenge button').forEach(b => b.disabled = true);
            document.getElementById('results').innerHTML = '‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ñ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤.';
        };

        // –ö–ª–∏–∫ –∫–æ–º–∞–Ω–¥—ã
        window.teamClick = function() {
            const currentClicks = (teams[myTeam]?.clicks || 0) + 1;
            set(ref(db, `rooms/${roomCode}/teams/${myTeam}`), { ...teams[myTeam], clicks: currentClicks });
            document.getElementById('click-count').textContent = currentClicks;
            // –í–∏–±—Ä–∞—Ü–∏—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
            if (navigator.vibrate) navigator.vibrate(50);
        };

        // –†–µ—Å–µ—Ç –∏–≥—Ä—ã
        window.resetGame = function() {
            remove(ref(db, `rooms/${roomCode}`));
            location.reload();
        };

        // –°–Ω–µ–≥
        function startSnow() {
            const snow = document.getElementById('snow');
            setInterval(() => {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.innerHTML = '‚ùÑ';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                flake.style.opacity = Math.random() * 0.5 + 0.3;
                snow.appendChild(flake);
                setTimeout(() => flake.remove(), 6000);
            }, 200);
        }
    </script>
</body>
</html>
